<script src="https://cdn.jsdelivr.net/npm/bignumber.js@9.1.2/bignumber.min.js"></script>
<script>
  // --- Default Game Data ---
  const defaultGameData = {
    energy: "10",
    eps: "0",
    generators: "0",
    generatorsCoal: "0",
    generatorsIron: "0",
    generatorsGold: "0",
    generatorsRuby: "0",
    generatorsEmerald: "0",
    generatorMax: { coal: 100, iron: 100, gold: 50, ruby: 25, emerald: 10 }
  };

  let username = "";
  let gameData = JSON.parse(JSON.stringify(defaultGameData));

  // --- Generator Config ---
  let multiplier = 1;
  const generatorConfig = {
    coal:    { baseCost: new BigNumber(10),    power: 1,  key: "generatorsCoal",    label: "Coal Generators",    button: "generateCoal",    span: "generatorsCoal",    max: defaultGameData.generatorMax.coal },
    iron:    { baseCost: new BigNumber(1000),  power: 3,  key: "generatorsIron",    label: "Iron Generators",    button: "generateIron",    span: "generatorsIron",    max: defaultGameData.generatorMax.iron },
    gold:    { baseCost: new BigNumber(3000),  power: 8,  key: "generatorsGold",    label: "Gold Generators",    button: "generateGold",    span: "generatorsGold",    max: defaultGameData.generatorMax.gold },
    ruby:    { baseCost: new BigNumber(6000),  power: 20, key: "generatorsRuby",    label: "Ruby Generators",    button: "generateRuby",    span: "generatorsRuby",    max: defaultGameData.generatorMax.ruby },
    emerald: { baseCost: new BigNumber(9000),  power: 50, key: "generatorsEmerald", label: "Emerald Generators", button: "generateEmerald", span: "generatorsEmerald", max: defaultGameData.generatorMax.emerald }
  };

  // --- Helpers ---
  function getEnergy() { return new BigNumber(gameData.energy); }
  function setEnergy(val) { gameData.energy = val.toString(); }
  function getEPS() { return new BigNumber(gameData.eps); }
  function setEPS(val) { gameData.eps = val.toString(); }
  function getGenCount(key) { return new BigNumber(gameData[key]); }
  function setGenCount(key, val) { gameData[key] = val.toString(); }
  function getTotalGenerators() { return new BigNumber(gameData.generators); }
  function setTotalGenerators(val) { gameData.generators = val.toString(); }

  function formatNumber(num) {
    if (!(num instanceof BigNumber)) num = new BigNumber(num);
    const suffixes = ['', 'k', 'm', 'b', 't', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc'];
    if (num.isLessThan(1000)) return num.toFixed(2).replace(/\.00$/, '');
    const exponent = num.e;
    const tier = Math.floor(exponent / 3);
    if (tier >= suffixes.length) return num.toExponential(3);
    const scaled = num.dividedBy(new BigNumber(10).pow(tier * 3));
    return scaled.toFixed(2).replace(/\.00$/, '') + suffixes[tier];
  }

  function getTotalCost(base, owned, amount) {
    return base.times(amount); // still flat cost; can replace with scaling if wanted
  }

  // --- UI Update ---
  function updateAllUI() {
    document.getElementById('energy').textContent = `Total Energy: ${formatNumber(getEnergy())}`;
    document.getElementById('eps').textContent = `EPS: ${formatNumber(getEPS())}`;
    document.getElementById('generators').textContent = `Generators: ${formatNumber(getTotalGenerators())}`;

    for (const key in generatorConfig) {
      const gen = generatorConfig[key];
      const owned = getGenCount(gen.key);

      if (owned.gte(gen.max)) {
        document.getElementById(gen.span).textContent = `${gen.label}: ${formatNumber(owned)} / ${gen.max}`;
        const btn = document.getElementById(gen.button);
        btn.textContent = `${gen.label} (MAXED)`;
        btn.disabled = true;
        continue;
      }

      const cost = getTotalCost(gen.baseCost, owned, multiplier);
      document.getElementById(gen.span).textContent = `${gen.label}: ${formatNumber(owned)} / ${gen.max}`;
      const btn = document.getElementById(gen.button);
      btn.textContent = `Buy ${gen.label.replace('s', '')} (Cost: ${formatNumber(cost)})`;
      btn.disabled = !getEnergy().gte(cost);
    }

    // Upgrade button status
    document.getElementById("upgradeMaxGen").disabled = !getEnergy().gte(1000);
  }

  // --- Purchase Logic ---
  function purchaseGenerator(key) {
    const gen = generatorConfig[key];
    const owned = getGenCount(gen.key);

    if (owned.gte(gen.max)) {
      alert(`You have reached the maximum number of ${gen.label}!`);
      return;
    }

    let actualBuyAmount = Math.min(multiplier, gen.max - owned.toNumber());
    const cost = getTotalCost(gen.baseCost, owned, actualBuyAmount);

    if (getEnergy().gte(cost)) {
      setEnergy(getEnergy().minus(cost));
      setEPS(getEPS().plus(new BigNumber(gen.power).times(actualBuyAmount)));
      setGenCount(gen.key, owned.plus(actualBuyAmount));
      setTotalGenerators(getTotalGenerators().plus(actualBuyAmount));
      updateAllUI();
    } else {
      alert("Not enough energy!");
    }
  }

  // --- Upgrade Logic ---
  function upgradeMaxGenerators() {
    const upgradeCost = new BigNumber(1000);
    if (getEnergy().gte(upgradeCost)) {
      setEnergy(getEnergy().minus(upgradeCost));
      for (const key in generatorConfig) {
        generatorConfig[key].max += 100;
        gameData.generatorMax[key] = generatorConfig[key].max; // persist upgrade
      }
      updateAllUI();
    }
  }

  // --- Save / Load / Reset ---
  function saveGame() {
    username = document.getElementById('username').value.trim();
    if (!username) { alert('Enter your username before saving.'); return; }

    // copy generator max values into save data
    const saveCopy = { ...gameData, generatorMax: {} };
    for (const key in generatorConfig) {
      saveCopy.generatorMax[key] = generatorConfig[key].max;
    }

    localStorage.setItem(username, JSON.stringify(saveCopy));
    localStorage.setItem('lastUsername', username);
    alert('Game saved!');
  }

  function loadGame() {
    username = document.getElementById('username').value.trim();
    if (!username) { alert('Enter a username first.'); return; }

    const savedData = localStorage.getItem(username);
    if (savedData) {
      const saved = JSON.parse(savedData);
      gameData = saved;

      // restore generator max values if saved
      if (saved.generatorMax) {
        for (const key in saved.generatorMax) {
          generatorConfig[key].max = saved.generatorMax[key];
        }
      }
      updateAllUI();
      alert('Game loaded!');
    } else {
      alert('No save found for this username.');
    }
  }

  function resetGame() {
    if (confirm("Are you sure you want to reset your game? This cannot be undone!")) {
      gameData = JSON.parse(JSON.stringify(defaultGameData));
      for (const key in generatorConfig) {
        generatorConfig[key].max = defaultGameData.generatorMax[key];
      }
      if (username) {
        localStorage.removeItem(username);
      }
      updateAllUI();
      alert("Game reset to original state!");
    }
  }

  // --- Event Listeners ---
  document.getElementById('purchase-multiplier').onchange = function() {
    multiplier = parseInt(this.value, 10);
    updateAllUI();
  };
  for (const key in generatorConfig) {
    document.getElementById(generatorConfig[key].button).onclick = () => purchaseGenerator(key);
  }
  document.getElementById('upgradeMaxGen').onclick = upgradeMaxGenerators;
  document.getElementById('saveBtn').onclick = saveGame;
  document.getElementById('loadBtn').onclick = loadGame;
  document.getElementById('resetBtn').onclick = resetGame;

  // --- Auto-load last username ---
  window.onload = function() {
    const lastUser = localStorage.getItem('lastUsername');
    if (lastUser) {
      document.getElementById('username').value = lastUser;
      username = lastUser;
      loadGame();
    } else {
      updateAllUI();
    }
  };

  // --- Game Loop ---
  setInterval(() => {
    let totalAdd = new BigNumber(0);
    for (const key in generatorConfig) {
      totalAdd = totalAdd.plus(getGenCount(generatorConfig[key].key).times(generatorConfig[key].power));
    }
    setEnergy(getEnergy().plus(totalAdd));
    updateAllUI();
  }, 1000);
</script>
