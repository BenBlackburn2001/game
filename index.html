<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generator Game</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Purchase Multiplier Dropdown -->
  <div id="purchase-multiplier-container">
    <label for="purchase-multiplier">Purchase:</label>
    <select id="purchase-multiplier">
      <option value="1">1x</option>
      <option value="2">2x</option>
      <option value="3">3x</option>
      <option value="5">5x</option>
      <option value="10">10x</option>
      <option value="20">20x</option>
      <option value="50">50x</option>
      <option value="100">100x</option>
    </select>
  </div>

  <main>
    <h1>Generators Game</h1>
    <div id="energy">Total Energy: 10</div>
    <div id="eps">EPS: 0</div>
    <div id="generators">Generators: 0</div>

    <section id="generators-section">
      <div class="generator-row">
        <span id="generatorsCoal" class="generator-label">Coal Generators: 0</span>
        <button id="generateCoal" class="generator-btn">Buy Coal Generator (Cost: 10)</button>
      </div>
      <div class="generator-row">
        <span id="generatorsIron" class="generator-label">Iron Generators: 0</span>
        <button id="generateIron" class="generator-btn">Buy Iron Generator (Cost: 1k)</button>
      </div>
      <div class="generator-row">
        <span id="generatorsGold" class="generator-label">Gold Generators: 0</span>
        <button id="generateGold" class="generator-btn">Buy Gold Generator (Cost: 3k)</button>
      </div>
      <div class="generator-row">
        <span id="generatorsRuby" class="generator-label">Ruby Generators: 0</span>
        <button id="generateRuby" class="generator-btn">Buy Ruby Generator (Cost: 6k)</button>
      </div>
      <div class="generator-row">
        <span id="generatorsEmerald" class="generator-label">Emerald Generators: 0</span>
        <button id="generateEmerald" class="generator-btn">Buy Emerald Generator (Cost: 9k)</button>
      </div>
    </section>

    <h2>Leaderboard</h2>
    <ul id="leaderboard"></ul>
  </main>

  <!-- BigNumber.js and Socket.io scripts here -->
  <script src="https://cdn.jsdelivr.net/npm/bignumber.js@9.1.2/bignumber.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // --- Game State ---
    let energy = new BigNumber(10);
    let eps = new BigNumber(0);
    let generators = new BigNumber(0);
    let generatorsCoal = new BigNumber(0);
    let generatorsIron = new BigNumber(0);
    let generatorsGold = new BigNumber(0);
    let generatorsRuby = new BigNumber(0);  
    let generatorsEmerald = new BigNumber(0);

    // --- Generator Cost and Scaling ---
    let multiplier = 1;
    const coalBaseCost = new BigNumber(10);
    const ironBaseCost = new BigNumber(1000);
    const goldBaseCost = new BigNumber(3000);
    const rubyBaseCost = new BigNumber(6000);
    const emeraldBaseCost = new BigNumber(9000);

    const coalCostScale = new BigNumber(1.00015);
    const ironCostScale = new BigNumber(1.00025);
    const goldCostScale = new BigNumber(1.00035);
    const rubyCostScale = new BigNumber(1.00045); 
    const emeraldCostScale = new BigNumber(1.00055);

    // --- Generator Power (EPS per generator) ---
    const generatorPower = {
      coal: 1,
      iron: 2,
      gold: 3,
      ruby: 4,
      emerald: 5
    };

    // --- Socket.io ---
    const socket = io('http://localhost:3000');

    // --- Number Formatting ---
    function formatNumber(num) {
      if (num instanceof BigNumber) num = num.toNumber();
      const suffixes = [
        '', 'k', 'm', 'b', 't', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No',
        'Dc', 'Ud', 'Dd', 'Td', 'Qad', 'Qid', 'Sxd', 'Spd', 'Ocd', 'Nod',
        'Vg', 'Uv', 'Dv', 'Tv', 'Qav', 'Qiv', 'Sxv', 'Spv', 'Ocv', 'Nov', 'Tg',
        'Utg', 'Dtg', 'Ttg', 'Qatg', 'Qitg', 'Sxtg', 'Sptg', 'Octg', 'Notg', 'Qag'
      ];
      if (num < 1000) return num;
      const tier = Math.floor(Math.log10(num) / 3);
      if (tier >= suffixes.length) return num.toExponential(2);
      const suffix = suffixes[tier];
      const scale = Math.pow(10, tier * 3);
      let scaled = num / scale;
      scaled = scaled.toFixed(2).replace(/\.00$/, '');
      return scaled + suffix;
    }
  
    function getTotalCost(base, scale, owned, amount) {
      if (amount === 1) {
    return base.times(scale.pow(owned));
    }
    // S = a * (r^n - 1) / (r - 1)
    const scalePowOwned = scale.pow(owned);
    const scalePowAmount = scale.pow(amount);
    const numerator = scalePowAmount.minus(1);
    const denominator = scale.minus(1);
    return base.times(scalePowOwned).times(numerator).div(denominator).integerValue(BigNumber.ROUND_FLOOR);
  }


    // --- UI Update Functions ---
    function updateButtonCosts() {
      document.getElementById('generateCoal').textContent =
        `Buy Coal Generator (Cost: ${formatNumber(getTotalCost(coalBaseCost, coalCostScale, generatorsCoal, multiplier))})`;
      document.getElementById('generateIron').textContent =
        `Buy Iron Generator (Cost: ${formatNumber(getTotalCost(ironBaseCost, ironCostScale, generatorsIron, multiplier))})`;
      document.getElementById('generateGold').textContent =
        `Buy Gold Generator (Cost: ${formatNumber(getTotalCost(goldBaseCost, goldCostScale, generatorsGold, multiplier))})`;
      document.getElementById('generateRuby').textContent =
        `Buy Ruby Generator (Cost: ${formatNumber(getTotalCost(rubyBaseCost, rubyCostScale, generatorsRuby, multiplier))})`;
      document.getElementById('generateEmerald').textContent =
        `Buy Emerald Generator (Cost: ${formatNumber(getTotalCost(emeraldBaseCost, emeraldCostScale, generatorsEmerald, multiplier))})`;
    }

    function updateStats() {
      document.getElementById('energy').textContent = `Total Energy: ${formatNumber(energy)}`;
      document.getElementById('eps').textContent = `EPS: ${formatNumber(eps)}`;
      document.getElementById('generators').textContent = `Generators: ${formatNumber(generators)}`;
      document.getElementById('generatorsCoal').textContent = `Coal Generators: ${formatNumber(generatorsCoal)}`;
      document.getElementById('generatorsIron').textContent = `Iron Generators: ${formatNumber(generatorsIron)}`;
      document.getElementById('generatorsGold').textContent = `Gold Generators: ${formatNumber(generatorsGold)}`;
      document.getElementById('generatorsRuby').textContent = `Ruby Generators: ${formatNumber(generatorsRuby)}`;
      document.getElementById('generatorsEmerald').textContent = `Emerald Generators: ${formatNumber(generatorsEmerald)}`;
    }

    // --- Purchase Multiplier Change ---
    document.getElementById('purchase-multiplier').onchange = function() {
      multiplier = parseInt(this.value, 10);
      updateButtonCosts();
    };

    // --- Initial UI Update ---
    updateButtonCosts();
    updateStats();

    // --- Generator Purchase Handlers ---
    document.getElementById('generateCoal').onclick = () => {
      const totalCost = getTotalCost(coalBaseCost, coalCostScale, generatorsCoal, multiplier);
      if (energy.gte(totalCost)) {
        energy = energy.minus(totalCost);
        eps = eps.plus(new BigNumber(generatorPower.coal).times(multiplier));
        generatorsCoal = generatorsCoal.plus(multiplier);
        generators = generators.plus(multiplier);
        updateStats();
        updateButtonCosts();
      } else {
        alert('Not enough energy to buy generators!');
      }
    };

    document.getElementById('generateIron').onclick = () => {
      const totalCost = getTotalCost(ironBaseCost, ironCostScale, generatorsIron, multiplier);
      if (energy.gte(totalCost)) {
        energy = energy.minus(totalCost);
        eps = eps.plus(new BigNumber(generatorPower.iron).times(multiplier));
        generatorsIron = generatorsIron.plus(multiplier);
        generators = generators.plus(multiplier);
        updateStats();
        updateButtonCosts();
      } else {
        alert('Not enough energy to buy generators!');
      }
    };

    document.getElementById('generateGold').onclick = () => {
      const totalCost = getTotalCost(goldBaseCost, goldCostScale, generatorsGold, multiplier);
      if (energy.gte(totalCost)) {
        energy = energy.minus(totalCost);
        eps = eps.plus(new BigNumber(generatorPower.gold).times(multiplier));
        generatorsGold = generatorsGold.plus(multiplier);
        generators = generators.plus(multiplier);
        updateStats();
        updateButtonCosts();
      } else {
        alert('Not enough energy to buy generators!');
      }
    };

    document.getElementById('generateRuby').onclick = () => {
      const totalCost = getTotalCost(rubyBaseCost, rubyCostScale, generatorsRuby, multiplier);
      if (energy.gte(totalCost)) {
        energy = energy.minus(totalCost);
        eps = eps.plus(new BigNumber(generatorPower.ruby).times(multiplier));
        generatorsRuby = generatorsRuby.plus(multiplier);
        generators = generators.plus(multiplier);
        updateStats();
        updateButtonCosts();
      } else {
        alert('Not enough energy to buy generators!');
      }
    };

    document.getElementById('generateEmerald').onclick = () => {
      const totalCost = getTotalCost(emeraldBaseCost, emeraldCostScale, generatorsEmerald, multiplier);
      if (energy.gte(totalCost)) {
        energy = energy.minus(totalCost);
        eps = eps.plus(new BigNumber(generatorPower.emerald).times(multiplier));
        generatorsEmerald = generatorsEmerald.plus(multiplier);
        generators = generators.plus(multiplier);
        updateStats();
        updateButtonCosts();
      } else {
        alert('Not enough energy to buy generators!');
      }
    };

let lastEnergy = energy;

setInterval(() => {
  // Each generator type adds its own energy per second
  energy = energy.plus(generatorsCoal.times(generatorPower.coal));
  energy = energy.plus(generatorsIron.times(generatorPower.iron));
  energy = energy.plus(generatorsGold.times(generatorPower.gold));
  energy = energy.plus(generatorsRuby.times(generatorPower.ruby));
  energy = energy.plus(generatorsEmerald.times(generatorPower.emerald));

  // Only update DOM if energy changed
  if (!energy.eq(lastEnergy)) {
    document.getElementById('energy').textContent = `Total Energy: ${formatNumber(energy)}`;
    lastEnergy = energy;
  }
}, 1000);

    // --- Leaderboard Update ---
    socket.on('leaderboard', (data) => {
      const list = document.getElementById('leaderboard');
      list.innerHTML = '';
      data.forEach(player => {
        const li = document.createElement('li');
        li.textContent = `${player.email}: ${player.eps} EPS`;
        list.appendChild(li);
      });
    });
  </script>
</body>
</html>