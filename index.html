<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generator Game</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="purchase-multiplier-container">
    <label for="purchase-multiplier">Purchase:</label>
    <select id="purchase-multiplier">
      <option value="1">1x</option>
      <option value="2">2x</option>
      <option value="3">3x</option>
      <option value="5">5x</option>
      <option value="10">10x</option>
      <option value="20">20x</option>
      <option value="50">50x</option>
      <option value="100">100x</option>
    </select>
  </div>
  <div>
  <input id="username" placeholder="Enter username" />
  <button id="saveBtn">Save Game</button>
  <button id="loadBtn">Load Game</button>
</div>

  <main>
    <h1>Generators Game</h1>
    <div id="energy">Total Energy: 10</div>
    <div id="eps">EPS: 0</div>
    <div id="generators">Generators: 0</div>

    <section id="generators-section">
      <div class="generator-row">
        <span id="generatorsCoal" class="generator-label">Coal Generators: 0</span>
        <button id="generateCoal" class="generator-btn">Buy Coal Generator (Cost: 10)</button>
      </div>
      <div class="generator-row">
        <span id="generatorsIron" class="generator-label">Iron Generators: 0</span>
        <button id="generateIron" class="generator-btn">Buy Iron Generator (Cost: 1k)</button>
      </div>
      <div class="generator-row">
        <span id="generatorsGold" class="generator-label">Gold Generators: 0</span>
        <button id="generateGold" class="generator-btn">Buy Gold Generator (Cost: 3k)</button>
      </div>
      <div class="generator-row">
        <span id="generatorsRuby" class="generator-label">Ruby Generators: 0</span>
        <button id="generateRuby" class="generator-btn">Buy Ruby Generator (Cost: 6k)</button>
      </div>
      <div class="generator-row">
        <span id="generatorsEmerald" class="generator-label">Emerald Generators: 0</span>
        <button id="generateEmerald" class="generator-btn">Buy Emerald Generator (Cost: 9k)</button>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bignumber.js@9.1.2/bignumber.min.js"></script>
  <script>
    // --- Game State ---
    let energy = new BigNumber(10);
    let eps = new BigNumber(0);
    let generators = new BigNumber(0);
    let generatorsCoal = new BigNumber(0);
    let generatorsIron = new BigNumber(0);
    let generatorsGold = new BigNumber(0);
    let generatorsRuby = new BigNumber(0);  
    let generatorsEmerald = new BigNumber(0);

    // --- Generator Config (with scaling) ---
    let multiplier = 1;
    const generatorConfig = {
      coal: {
        baseCost: new BigNumber(10),
        costScale: new BigNumber(1),
        power: 1,
        owned: () => generatorsCoal,
        setOwned: v => generatorsCoal = v,
        label: 'Coal Generators',
        button: 'generateCoal',
        span: 'generatorsCoal'
      },
      iron: {
        baseCost: new BigNumber(1000),
        costScale: new BigNumber(1),
        power: 2,
        owned: () => generatorsIron,
        setOwned: v => generatorsIron = v,
        label: 'Iron Generators',
        button: 'generateIron',
        span: 'generatorsIron'
      },
      gold: {
        baseCost: new BigNumber(3000),
        costScale: new BigNumber(1),
        power: 3,
        owned: () => generatorsGold,
        setOwned: v => generatorsGold = v,
        label: 'Gold Generators',
        button: 'generateGold',
        span: 'generatorsGold'
      },
      ruby: {
        baseCost: new BigNumber(6000),
        costScale: new BigNumber(1),
        power: 4,
        owned: () => generatorsRuby,
        setOwned: v => generatorsRuby = v,
        label: 'Ruby Generators',
        button: 'generateRuby',
        span: 'generatorsRuby'
      },
      emerald: {
        baseCost: new BigNumber(9000),
        costScale: new BigNumber(1),
        power: 5,
        owned: () => generatorsEmerald,
        setOwned: v => generatorsEmerald = v,
        label: 'Emerald Generators',
        button: 'generateEmerald',
        span: 'generatorsEmerald'
      }
    };


    let username = '';

function saveGame() {
  if (!username) {
    alert('Enter your username before saving.');
    return;
  }

  const gameData = {
    energy: energy.toString(),
    eps: eps.toString(),
    generators: generators.toString(),
    generatorsCoal: generatorsCoal.toString(),
    generatorsIron: generatorsIron.toString(),
    generatorsGold: generatorsGold.toString(),
    generatorsRuby: generatorsRuby.toString(),
    generatorsEmerald: generatorsEmerald.toString()
  };

  localStorage.setItem(username, JSON.stringify(gameData));
  alert('Game saved locally!');
}

function loadGame() {
  username = document.getElementById('username').value.trim();
  if (!username) {
    alert('Enter a username first.');
    return;
  }

  const savedData = localStorage.getItem(username);
  if (savedData) {
    const data = JSON.parse(savedData);
    energy = new BigNumber(data.energy);
    eps = new BigNumber(data.eps);
    generators = new BigNumber(data.generators);
    generatorsCoal = new BigNumber(data.generatorsCoal);
    generatorsIron = new BigNumber(data.generatorsIron);
    generatorsGold = new BigNumber(data.generatorsGold);
    generatorsRuby = new BigNumber(data.generatorsRuby);
    generatorsEmerald = new BigNumber(data.generatorsEmerald);
    updateAllUI();
    alert('Game loaded!');
  } else {
    alert('No save found for this username.');
  }
}

    // --- Number Formatting ---
    function formatNumber(num) {
      if (!(num instanceof BigNumber)) num = new BigNumber(num);
      const suffixes = [
        '', 'k', 'm', 'b', 't', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No',
        'Dc', 'Ud', 'Dd', 'Td', 'Qad', 'Qid', 'Sxd', 'Spd', 'Ocd', 'Nod',
        'Vg', 'Uv', 'Dv', 'Tv', 'Qav', 'Qiv', 'Sxv', 'Spv', 'Ocv', 'Nov', 'Tg',
        'Utg', 'Dtg', 'Ttg', 'Qatg', 'Qitg', 'Sxtg', 'Sptg', 'Octg', 'Notg', 'Qag'
      ];
      if (num.isLessThan(1000)) return num.toFixed(2).replace(/\.00$/, '');
      const exponent = num.e;
      const tier = Math.floor(exponent / 3);
      if (tier >= suffixes.length) return num.toExponential(3);
      const scaled = num.dividedBy(new BigNumber(10).pow(tier * 3));
      return scaled.toFixed(2).replace(/\.00$/, '') + suffixes[tier];
    }

    // --- Lag-Free Scaling Cost Calculation ---
    function getTotalCost(base, scale, owned, amount) {
      if (scale.eq(1)) {
        return base.times(amount);
      }
      const scalePowOwned = scale.pow(owned);
      const scalePowAmount = scale.pow(amount);
      const numerator = scalePowAmount.minus(1);
      const denominator = scale.minus(1);
      return base.times(scalePowOwned).times(numerator).div(denominator).integerValue(BigNumber.ROUND_FLOOR);
    }

    // --- UI Update Functions (batched & disables buttons if unaffordable) ---
    function updateAllUI() {
      document.getElementById('energy').textContent = `Total Energy: ${formatNumber(energy)}`;
      document.getElementById('eps').textContent = `EPS: ${formatNumber(eps)}`;
      document.getElementById('generators').textContent = `Generators: ${formatNumber(generators)}`;
      for (const key in generatorConfig) {
        const gen = generatorConfig[key];
        const cost = getTotalCost(gen.baseCost, gen.costScale, gen.owned(), multiplier);
        document.getElementById(gen.span).textContent = `${gen.label}: ${formatNumber(gen.owned())}`;
        const btn = document.getElementById(gen.button);
        btn.textContent = `Buy ${gen.label.replace('s', '')} (Cost: ${formatNumber(cost)})`;
        btn.disabled = !energy.gte(cost);
        btn.classList.toggle('disabled', btn.disabled);
      }
    }

    // --- Purchase Multiplier Change ---
    document.getElementById('purchase-multiplier').onchange = function() {
      multiplier = parseInt(this.value, 10);
      updateAllUI();
    };

    // --- Debounce Utility ---
    function debounce(fn, delay) {
      let lastCall = 0;
      return function(...args) {
        const now = Date.now();
        if (now - lastCall > delay) {
          lastCall = now;
          fn.apply(this, args);
        }
      };
    }

    // --- Generic Purchase Handler ---
    function purchaseGenerator(key) {
      const gen = generatorConfig[key];
      const totalCost = getTotalCost(gen.baseCost, gen.costScale, gen.owned(), multiplier);
      if (energy.gte(totalCost)) {
        energy = energy.minus(totalCost);
        eps = eps.plus(new BigNumber(gen.power).times(multiplier));
        gen.setOwned(gen.owned().plus(multiplier));
        generators = generators.plus(multiplier);
        updateAllUI();
      }
    }

    // --- Attach Debounced Handlers Once ---
    for (const key in generatorConfig) {
      document.getElementById(generatorConfig[key].button).onclick = debounce(() => purchaseGenerator(key), 50);
    }

    document.getElementById('saveBtn').onclick = saveGame;
    document.getElementById('loadBtn').onclick = loadGame;

    // --- Initial UI Update ---
    updateAllUI();

    // --- Energy Generation Interval (batched) ---
    setInterval(() => {
      let totalAdd = new BigNumber(0);
      for (const key in generatorConfig) {
        const gen = generatorConfig[key];
        totalAdd = totalAdd.plus(gen.owned().times(gen.power));
      }
      energy = energy.plus(totalAdd);
      document.getElementById('energy').textContent = `Total Energy: ${formatNumber(energy)}`;
      updateAllUI();
    }, 1000);


    
  </script>
</body>
</html>