<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generator Game</title>
  <link href="https://fonts.googleapis.com/css?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .factory-anim-container {
      margin-top: 8px;
      min-height: 52px;
    }
    .factory-animation {
      display: inline-block;
      width: 48px;
      height: 48px;
      margin: 2px;
      vertical-align: middle;
      animation: factoryPulse 1.2s infinite;
    }
    @keyframes factoryPulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.08); opacity: 0.85; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="purchase-multiplier-container">
    <label for="purchase-multiplier">Purchase:</label>
    <select id="purchase-multiplier">
      <option value="1">1x</option>
      <option value="2">2x</option>
      <option value="5">5x</option>
      <option value="10">10x</option>
      <option value="50">50x</option>
      <option value="100">100x</option>
      <option value="1000">1,000x</option>
    </select>
  </div>
  <div class="menu-bar">
    <button id="homeBtn" class="menu-button">Home</button>
    <input type="text" id="username" placeholder="Username">
    <button id="saveBtn" class="menu-button">Save Game</button>
    <button id="loadBtn" class="menu-button">Load Game</button>
    <button id="resetBtn" class="menu-button">Reset Game</button>
    <button id="storeBtn" class="menu-button">Store</button>
    <button id="codeBtn" class="menu-button">Enter Code</button>
  </div>
  <main>
    <h1>Generators Game</h1>
    <div class="main-stats">
      <div id="energy">Total Energy: 10</div>
      <div id="eps">EPS: 0</div>
      <div id="generators">Generators: 0</div>
    </div>
    <div id="tier-selector" class="tier-selector">
      <button class="tier-btn active" data-tier="1">Tier 1</button>
      <button class="tier-btn" data-tier="2">Tier 2</button>
      <button class="tier-btn" data-tier="3">Tier 3</button>
      <button class="tier-btn" data-tier="4">Tier 4</button>
      <button class="tier-btn" data-tier="5">Tier 5</button>
    </div>
    <section id="generators-section"></section>
    <!-- Code Input Modal -->
    <div id="code-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(24,26,27,0.96); z-index:10001; align-items:center; justify-content:center;">
      <div style="background:#23272b; border-radius:16px; box-shadow:0 4px 32px #000a; padding:32px 24px; max-width:400px; width:90vw; margin:auto; position:relative;">
        <button id="closeCodeBtn" style="position:absolute; top:12px; right:16px; background:none; border:none; color:#ffb300; font-size:1.5em; cursor:pointer;">&times;</button>
        <h2 style="color:#ffb300; text-align:center; margin-bottom:24px; font-family:'Orbitron',monospace;">Redeem Code</h2>
        <input id="codeInput" type="text" placeholder="Enter code here" style="width:100%; padding:10px; border-radius:6px; border:2px solid #444950; font-size:1em; margin-bottom:16px; background:#181a1b; color:#fff;">
        <button id="redeemCodeBtn" class="menu-button" style="width:100%;">Redeem</button>
        <div id="codeResultMsg" style="color:#69f0ae; margin-top:8px; display:none;"></div>
      </div>
    </div>
    <!-- Store Modal -->
    <div id="store-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(24,26,27,0.96); z-index:10000; align-items:center; justify-content:center;">
      <div style="background:#23272b; border-radius:16px; box-shadow:0 4px 32px #000a; padding:32px 24px; max-width:400px; width:90vw; margin:auto; position:relative;">
        <button id="closeStoreBtn" style="position:absolute; top:12px; right:16px; background:none; border:none; color:#ffb300; font-size:1.5em; cursor:pointer;">&times;</button>
        <h2 style="color:#ffb300; text-align:center; margin-bottom:24px; font-family:'Orbitron',monospace;">Store</h2>
        <div id="store-items">
          <div style="margin-bottom:18px; padding:12px; background:#181a1b; border-radius:8px;">
            <div style="font-weight:bold; color:#fff;">24h 2x Energy Output</div>
            <div style="color:#ffb300; margin-bottom:8px;">Cost: 100,000 Energy</div>
            <button id="buy-boost-2x" class="menu-button" style="width:100%;">Buy Boost</button>
            <div id="boost-active-msg" style="color:#69f0ae; margin-top:8px; display:none;">Active!</div>
          </div>
          <div style="margin-bottom:18px; padding:12px; background:#181a1b; border-radius:8px;">
            <div style="font-weight:bold; color:#fff;">Permanent 2x Coal Generator Output</div>
            <div style="color:#ffb300; margin-bottom:8px;">Cost: 1,000,000 Energy</div>
            <button id="buy-perm-2x-coal" class="menu-button" style="width:100%;">Buy Permanent Boost</button>
            <div id="perm-coal-active-msg" style="color:#69f0ae; margin-top:8px; display:none;">Purchased!</div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <div id="toast-container"></div>
<script src="https://cdn.jsdelivr.net/npm/bignumber.js@9.1.2/bignumber.min.js"></script>
<script>
  // --- Store Boost State ---
  let boost2xActive = false;
  let boost2xEndTime = 0;
  let perm2xCoal = false;
  let perm2xIron = false;

  // --- Toast Notification ---
  function showToast(message) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.transition = 'opacity 0.5s';
      toast.style.opacity = '0';
      setTimeout(() => container.removeChild(toast), 500);
    }, 2000);
  }

  // --- Initial Upgrade/Max Upgrade Costs for Reset ---
  const initialUpgradeCosts = {
    coal: 20, iron: 200, gold: 600, ruby: 1800, emerald: 4000,
    diamond: 1e6, platinum: 5e6, uranium: 2e7, sapphire: 1e8, obsidian: 5e8,
    mythril: 1e10, amethyst: 5e10, topaz: 2e11, onyx: 1e12, crystal: 5e12,
    void: 1e14, nebula: 5e14, quantum: 2e15, singularity: 1e16, eternity: 5e16,
    omega: 1e18, alpha: 5e18, zeta: 2e19, lambda: 1e20, sigma: 5e20
  };
  const initialMaxUpgradeCosts = {
    coal: 1000, iron: 1000, gold: 1000, ruby: 1000, emerald: 1000,
    diamond: 1e15, platinum: 1e18, uranium: 1e21, sapphire: 1e24, obsidian: 1e27,
    mythril: 1e30, amethyst: 1e33, topaz: 1e36, onyx: 1e39, crystal: 1e42,
    void: 1e45, nebula: 1e48, quantum: 1e51, singularity: 1e54, eternity: 1e57,
    omega: 1e60, alpha: 1e63, zeta: 1e66, lambda: 1e69, sigma: 1e72
  };

  // --- Default Game Data ---
  const defaultGameData = {
    energy: "10",
    eps: "0",
    generators: "0",
    generatorsCoal: "0",
    generatorsIron: "0",
    generatorsGold: "0",
    generatorsRuby: "0",
    generatorsEmerald: "0",
    generatorsDiamond: "0",
    generatorsPlatinum: "0",
    generatorsUranium: "0",
    generatorsSapphire: "0",
    generatorsObsidian: "0",
    generatorsMythril: "0",
    generatorsAmethyst: "0",
    generatorsTopaz: "0",
    generatorsOnyx: "0",
    generatorsCrystal: "0",
    generatorsVoid: "0",
    generatorsNebula: "0",
    generatorsQuantum: "0",
    generatorsSingularity: "0",
    generatorsEternity: "0",
    generatorsOmega: "0",
    generatorsAlpha: "0",
    generatorsZeta: "0",
    generatorsLambda: "0",
    generatorsSigma: "0",
    generatorMax: {
      coal: 100, iron: 100, gold: 50, ruby: 25, emerald: 10, diamond: 1,
      platinum: 1, uranium: 1, sapphire: 1, obsidian: 1,
      mythril: 1, amethyst: 1, topaz: 1, onyx: 1, crystal: 1,
      void: 1, nebula: 1, quantum: 1, singularity: 1, eternity: 1,
      omega: 1, alpha: 1, zeta: 1, lambda: 1, sigma: 1
    }
  };

  let username = "";
  let gameData = JSON.parse(JSON.stringify(defaultGameData));
  let multiplier = 1;

  // --- Upgrades State ---
  const generatorUpgrades = {};
  const generatorMaxUpgrades = {};
  // --- Generator Config (with tier property) ---
  const generatorConfig = {
    // Tier 1
    coal:    { tier: 1, baseCost: new BigNumber(10),    power: () => 1 + generatorUpgrades.coal.level * 1.5,  key: "generatorsCoal",    label: "Coal Generators",    button: "generateCoal",    span: "generatorsCoal",    max: defaultGameData.generatorMax.coal, upgrade: "upgradeCoal", sell: "sellCoal", maxBtn: "maxCoal" },
    iron:    { tier: 1, baseCost: new BigNumber(100),   power: () => 5 + generatorUpgrades.iron.level * 2,    key: "generatorsIron",    label: "Iron Generators",    button: "generateIron",    span: "generatorsIron",    max: defaultGameData.generatorMax.iron, upgrade: "upgradeIron", sell: "sellIron", maxBtn: "maxIron" },
    gold:    { tier: 1, baseCost: new BigNumber(300),   power: () => 15 + generatorUpgrades.gold.level * 3,   key: "generatorsGold",    label: "Gold Generators",    button: "generateGold",    span: "generatorsGold",    max: defaultGameData.generatorMax.gold, upgrade: "upgradeGold", sell: "sellGold", maxBtn: "maxGold" },
    ruby:    { tier: 1, baseCost: new BigNumber(900),   power: () => 40 + generatorUpgrades.ruby.level * 4,   key: "generatorsRuby",    label: "Ruby Generators",    button: "generateRuby",    span: "generatorsRuby",    max: defaultGameData.generatorMax.ruby, upgrade: "upgradeRuby", sell: "sellRuby", maxBtn: "maxRuby" },
    emerald: { tier: 1, baseCost: new BigNumber(2000),  power: () => 100 + generatorUpgrades.emerald.level * 5, key: "generatorsEmerald", label: "Emerald Generators", button: "generateEmerald", span: "generatorsEmerald", max: defaultGameData.generatorMax.emerald, upgrade: "upgradeEmerald", sell: "sellEmerald", maxBtn: "maxEmerald" },
    // Tier 2
    diamond:   { tier: 2, baseCost: new BigNumber("1e5"),  power: () => 1e4 + generatorUpgrades.diamond.level * 1e4, key: "generatorsDiamond", label: "Diamond Generators", button: "generateDiamond", span: "generatorsDiamond", max: defaultGameData.generatorMax.diamond, upgrade: "upgradeDiamond", sell: "sellDiamond", maxBtn: "maxDiamond" },
    platinum:  { tier: 2, baseCost: new BigNumber("5e5"),  power: () => 5e4 + generatorUpgrades.platinum.level * 2e4, key: "generatorsPlatinum", label: "Platinum Generators", button: "generatePlatinum", span: "generatorsPlatinum", max: defaultGameData.generatorMax.platinum, upgrade: "upgradePlatinum", sell: "sellPlatinum", maxBtn: "maxPlatinum" },
    uranium:   { tier: 2, baseCost: new BigNumber("2e6"),  power: () => 2e5 + generatorUpgrades.uranium.level * 5e4, key: "generatorsUranium", label: "Uranium Generators", button: "generateUranium", span: "generatorsUranium", max: defaultGameData.generatorMax.uranium, upgrade: "upgradeUranium", sell: "sellUranium", maxBtn: "maxUranium" },
    sapphire:  { tier: 2, baseCost: new BigNumber("1e7"),  power: () => 1e6 + generatorUpgrades.sapphire.level * 1e5, key: "generatorsSapphire", label: "Sapphire Generators", button: "generateSapphire", span: "generatorsSapphire", max: defaultGameData.generatorMax.sapphire, upgrade: "upgradeSapphire", sell: "sellSapphire", maxBtn: "maxSapphire" },
    obsidian:  { tier: 2, baseCost: new BigNumber("5e7"),  power: () => 5e6 + generatorUpgrades.obsidian.level * 2e5, key: "generatorsObsidian", label: "Obsidian Generators", button: "generateObsidian", span: "generatorsObsidian", max: defaultGameData.generatorMax.obsidian, upgrade: "upgradeObsidian", sell: "sellObsidian", maxBtn: "maxObsidian" },
    // Tier 3
    mythril:   { tier: 3, baseCost: new BigNumber("1e9"),  power: () => 1e8 + generatorUpgrades.mythril.level * 1e7, key: "generatorsMythril", label: "Mythril Generators", button: "generateMythril", span: "generatorsMythril", max: defaultGameData.generatorMax.mythril, upgrade: "upgradeMythril", sell: "sellMythril", maxBtn: "maxMythril" },
    amethyst:  { tier: 3, baseCost: new BigNumber("5e9"),  power: () => 5e8 + generatorUpgrades.amethyst.level * 2e7, key: "generatorsAmethyst", label: "Amethyst Generators", button: "generateAmethyst", span: "generatorsAmethyst", max: defaultGameData.generatorMax.amethyst, upgrade: "upgradeAmethyst", sell: "sellAmethyst", maxBtn: "maxAmethyst" },
    topaz:     { tier: 3, baseCost: new BigNumber("2e10"), power: () => 2e9 + generatorUpgrades.topaz.level * 5e7, key: "generatorsTopaz", label: "Topaz Generators", button: "generateTopaz", span: "generatorsTopaz", max: defaultGameData.generatorMax.topaz, upgrade: "upgradeTopaz", sell: "sellTopaz", maxBtn: "maxTopaz" },
    onyx:      { tier: 3, baseCost: new BigNumber("1e11"), power: () => 1e10 + generatorUpgrades.onyx.level * 1e8, key: "generatorsOnyx", label: "Onyx Generators", button: "generateOnyx", span: "generatorsOnyx", max: defaultGameData.generatorMax.onyx, upgrade: "upgradeOnyx", sell: "sellOnyx", maxBtn: "maxOnyx" },
    crystal:   { tier: 3, baseCost: new BigNumber("5e11"), power: () => 5e10 + generatorUpgrades.crystal.level * 2e8, key: "generatorsCrystal", label: "Crystal Generators", button: "generateCrystal", span: "generatorsCrystal", max: defaultGameData.generatorMax.crystal, upgrade: "upgradeCrystal", sell: "sellCrystal", maxBtn: "maxCrystal" },
    // Tier 4
    void:        { tier: 4, baseCost: new BigNumber("1e13"), power: () => 1e12 + generatorUpgrades.void.level * 1e10, key: "generatorsVoid", label: "Void Generators", button: "generateVoid", span: "generatorsVoid", max: defaultGameData.generatorMax.void, upgrade: "upgradeVoid", sell: "sellVoid", maxBtn: "maxVoid" },
    nebula:      { tier: 4, baseCost: new BigNumber("5e13"), power: () => 5e12 + generatorUpgrades.nebula.level * 2e10, key: "generatorsNebula", label: "Nebula Generators", button: "generateNebula", span: "generatorsNebula", max: defaultGameData.generatorMax.nebula, upgrade: "upgradeNebula", sell: "sellNebula", maxBtn: "maxNebula" },
    quantum:     { tier: 4, baseCost: new BigNumber("2e14"), power: () => 2e13 + generatorUpgrades.quantum.level * 5e10, key: "generatorsQuantum", label: "Quantum Generators", button: "generateQuantum", span: "generatorsQuantum", max: defaultGameData.generatorMax.quantum, upgrade: "upgradeQuantum", sell: "sellQuantum", maxBtn: "maxQuantum" },
    singularity: { tier: 4, baseCost: new BigNumber("1e15"), power: () => 1e14 + generatorUpgrades.singularity.level * 1e11, key: "generatorsSingularity", label: "Singularity Generators", button: "generateSingularity", span: "generatorsSingularity", max: defaultGameData.generatorMax.singularity, upgrade: "upgradeSingularity", sell: "sellSingularity", maxBtn: "maxSingularity" },
    eternity:    { tier: 4, baseCost: new BigNumber("5e15"), power: () => 5e14 + generatorUpgrades.eternity.level * 2e11, key: "generatorsEternity", label: "Eternity Generators", button: "generateEternity", span: "generatorsEternity", max: defaultGameData.generatorMax.eternity, upgrade: "upgradeEternity", sell: "sellEternity", maxBtn: "maxEternity" },
    // Tier 5
    omega:   { tier: 5, baseCost: new BigNumber("1e17"), power: () => 1e16 + generatorUpgrades.omega.level * 1e13, key: "generatorsOmega", label: "Omega Generators", button: "generateOmega", span: "generatorsOmega", max: defaultGameData.generatorMax.omega, upgrade: "upgradeOmega", sell: "sellOmega", maxBtn: "maxOmega" },
    alpha:   { tier: 5, baseCost: new BigNumber("5e17"), power: () => 5e16 + generatorUpgrades.alpha.level * 2e13, key: "generatorsAlpha", label: "Alpha Generators", button: "generateAlpha", span: "generatorsAlpha", max: defaultGameData.generatorMax.alpha, upgrade: "upgradeAlpha", sell: "sellAlpha", maxBtn: "maxAlpha" },
    zeta:    { tier: 5, baseCost: new BigNumber("2e18"), power: () => 2e17 + generatorUpgrades.zeta.level * 5e13, key: "generatorsZeta", label: "Zeta Generators", button: "generateZeta", span: "generatorsZeta", max: defaultGameData.generatorMax.zeta, upgrade: "upgradeZeta", sell: "sellZeta", maxBtn: "maxZeta" },
    lambda:  { tier: 5, baseCost: new BigNumber("1e19"), power: () => 1e18 + generatorUpgrades.lambda.level * 1e14, key: "generatorsLambda", label: "Lambda Generators", button: "generateLambda", span: "generatorsLambda", max: defaultGameData.generatorMax.lambda, upgrade: "upgradeLambda", sell: "sellLambda", maxBtn: "maxLambda" },
    sigma:   { tier: 5, baseCost: new BigNumber("5e19"), power: () => 5e18 + generatorUpgrades.sigma.level * 2e14, key: "generatorsSigma", label: "Sigma Generators", button: "generateSigma", span: "generatorsSigma", max: defaultGameData.generatorMax.sigma, upgrade: "upgradeSigma", sell: "sellSigma", maxBtn: "maxSigma" }
  };

  // Initialize upgrades and max upgrades
  for (const key in generatorConfig) {
    generatorUpgrades[key] = { level: 0, cost: new BigNumber(initialUpgradeCosts[key]) };
    generatorMaxUpgrades[key] = { cost: new BigNumber(initialMaxUpgradeCosts[key]), increment: generatorConfig[key].tier === 1 ? 100 : 1 };
  }

  // --- Helpers ---
  function getEnergy() { return new BigNumber(gameData.energy); }
  function setEnergy(val) { gameData.energy = val.toString(); }
  function getEPS() { return new BigNumber(gameData.eps); }
  function setEPS(val) { gameData.eps = val.toString(); }
  function getGenCount(key) { return new BigNumber(gameData[key]); }
  function setGenCount(key, val) { gameData[key] = val.toString(); }
  function getTotalGenerators() { return new BigNumber(gameData.generators); }
  function setTotalGenerators(val) { gameData.generators = val.toString(); }

  function formatNumber(num) {
    if (!(num instanceof BigNumber)) num = new BigNumber(num);
    const suffixes = ['', 'k', 'm', 'b', 't', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc'];
    if (num.isLessThan(1000)) return num.toFixed(2).replace(/\.00$/, '');
    const exponent = num.e;
    const tier = Math.floor(exponent / 3);
    if (tier >= suffixes.length) return num.toExponential(3);
    const scaled = num.dividedBy(new BigNumber(10).pow(tier * 3));
    return scaled.toFixed(2).replace(/\.00$/, '') + suffixes[tier];
  }

  function getTotalCost(base, owned, amount) {
    return base.times(amount); // flat cost
  }

  // --- EPS Calculation ---
  function recalculateEPS() {
    let total = new BigNumber(0);
    for (const key in generatorConfig) {
      let power = generatorConfig[key].power();
      if (key === 'coal' && perm2xCoal) power *= 2;
      if (key === 'iron' && perm2xIron) power *= 2;
      total = total.plus(getGenCount(generatorConfig[key].key).times(power));
    }
    if (boost2xActive) total = total.times(2);
    setEPS(total);
  }

  // --- Factory Animation Update ---
  function updateFactoryAnimations() {
    for (const key in generatorConfig) {
      const gen = generatorConfig[key];
      let container = document.getElementById(`factory-anim-${key}`);
      if (!container) {
        // Find the generator row and add the container if missing
        const row = document.getElementById(gen.span)?.parentElement;
        if (row) {
          container = document.createElement('div');
          container.id = `factory-anim-${key}`;
          container.className = 'factory-anim-container';
          row.appendChild(container);
        }
      }
      if (!container) continue;
      const owned = getGenCount(gen.key).toNumber();
      const factoriesToShow = Math.min(owned, 10);
      container.innerHTML = '';
      for (let i = 0; i < factoriesToShow; i++) {
        const factoryDiv = document.createElement('div');
        factoryDiv.className = 'factory-animation';
        // Example SVG animation (replace with your own artwork)
        factoryDiv.innerHTML = `
          <svg viewBox="0 0 48 48" width="48" height="48">
            <rect x="8" y="24" width="32" height="16" rx="4" fill="#888"/>
            <rect x="12" y="20" width="8" height="8" fill="#bdbdbd"/>
            <rect x="28" y="20" width="8" height="8" fill="#bdbdbd"/>
            <rect x="20" y="12" width="8" height="12" fill="#ffd600"/>
            <rect x="22" y="8" width="4" height="4" fill="#ffb300"/>
            <rect x="16" y="36" width="4" height="4" fill="#fff"/>
            <rect x="28" y="36" width="4" height="4" fill="#fff"/>
          </svg>
        `;
        container.appendChild(factoryDiv);
      }
    }
  }

  // --- UI Update ---
  function updateAllUI() {
    document.getElementById('energy').textContent = `Total Energy: ${formatNumber(getEnergy())}`;
    document.getElementById('eps').textContent = `EPS: ${formatNumber(getEPS())}`;
    document.getElementById('generators').textContent = `Generators: ${formatNumber(getTotalGenerators())}`;
    // Store UI
    const boostMsg = document.getElementById('boost-active-msg');
    if (boostMsg) {
      if (boost2xActive) {
        boostMsg.style.display = '';
        boostMsg.textContent = `Active! Ends in ${formatBoostTime()}`;
      } else {
        boostMsg.style.display = 'none';
      }
    }
    // Permanent coal boost UI
    const permCoalMsg = document.getElementById('perm-coal-active-msg');
    const permCoalBtn = document.getElementById('buy-perm-2x-coal');
    if (permCoalMsg && permCoalBtn) {
      if (perm2xCoal) {
        permCoalMsg.style.display = '';
        permCoalBtn.disabled = true;
      } else {
        permCoalMsg.style.display = 'none';
        permCoalBtn.disabled = false;
      }
    }

    for (const key in generatorConfig) {
      if (!document.getElementById(generatorConfig[key].span)) continue;
      const gen = generatorConfig[key];
      const owned = getGenCount(gen.key);
      if (gameData.generatorMax && gameData.generatorMax[key] !== undefined) {
        gen.max = gameData.generatorMax[key];
      }
      const upgrade = generatorUpgrades[key];
      const upgradeBtn = document.getElementById(gen.upgrade);
      upgradeBtn.textContent = `Upgrade (Cost: ${formatNumber(upgrade.cost)}) [+${gen.power()}]`;
      upgradeBtn.disabled = !getEnergy().gte(upgrade.cost) || owned.lte(0);
      const maxBtn = document.getElementById(gen.maxBtn);
      const maxUpgrade = generatorMaxUpgrades[key];
      maxBtn.textContent = `Max+ (Cost: ${formatNumber(maxUpgrade.cost)}) [+${gen.max}]`;
      maxBtn.disabled = !getEnergy().gte(maxUpgrade.cost);
      const sellBtn = document.getElementById(gen.sell);
      sellBtn.disabled = owned.lte(0);
      if (owned.gte(gen.max)) {
        document.getElementById(gen.span).textContent = `${gen.label}: ${formatNumber(owned)} / ${gen.max}`;
        const btn = document.getElementById(gen.button);
        btn.textContent = `${gen.label} (MAXED)`;
        btn.disabled = true;
        continue;
      }
      const cost = getTotalCost(gen.baseCost, owned, multiplier);
      document.getElementById(gen.span).textContent = `${gen.label}: ${formatNumber(owned)} / ${gen.max}`;
      const btn = document.getElementById(gen.button);
      btn.textContent = `Buy ${gen.label.replace('s', '')} (Cost: ${formatNumber(cost)})`;
      btn.disabled = !getEnergy().gte(cost);
    }
    // Update factory animations
    updateFactoryAnimations();
  }

  // --- Purchase Logic ---
  function purchaseGenerator(key) {
    const gen = generatorConfig[key];
    const owned = getGenCount(gen.key);
    if (owned.gte(gen.max)) return;
    let actualBuyAmount = Math.min(multiplier, gen.max - owned.toNumber());
    const cost = getTotalCost(gen.baseCost, owned, actualBuyAmount);
    if (getEnergy().gte(cost)) {
      setEnergy(getEnergy().minus(cost));
      setGenCount(gen.key, owned.plus(actualBuyAmount));
      setTotalGenerators(getTotalGenerators().plus(actualBuyAmount));
      recalculateEPS();
      updateAllUI();
    }
  }

  // --- Sell Logic ---
  function sellGenerator(key) {
    const gen = generatorConfig[key];
    const owned = getGenCount(gen.key);
    if (owned.lte(0)) return;
    setGenCount(gen.key, owned.minus(1));
    setTotalGenerators(getTotalGenerators().minus(1));
    setEnergy(getEnergy().plus(gen.baseCost.times(0.5)));
    recalculateEPS();
    updateAllUI();
  }

  // --- Upgrade Logic (per generator) ---
  function upgradeGenerator(key) {
    const gen = generatorConfig[key];
    const upgrade = generatorUpgrades[key];
    const owned = getGenCount(gen.key);
    if (getEnergy().gte(upgrade.cost) && owned.gt(0)) {
      setEnergy(getEnergy().minus(upgrade.cost));
      upgrade.level += 1;
      upgrade.cost = upgrade.cost.times(2);
      recalculateEPS();
      updateAllUI();
    }
  }

  // --- Max Upgrade Logic (per generator) ---
  function upgradeMaxGenerator(key) {
    const gen = generatorConfig[key];
    const maxUpgrade = generatorMaxUpgrades[key];
    if (getEnergy().gte(maxUpgrade.cost)) {
      setEnergy(getEnergy().minus(maxUpgrade.cost));
      gen.max += maxUpgrade.increment;
      gameData.generatorMax[key] = gen.max;
      maxUpgrade.cost = maxUpgrade.cost.times(2);
      updateAllUI();
    }
  }

  // --- Save / Load / Reset ---
  function saveGame() {
    username = document.getElementById('username').value.trim();
    if (!username) { showToast('Enter your username before saving.'); return; }
    const saveCopy = { ...gameData, generatorMax: {} };
    for (const key in generatorConfig) {
      saveCopy.generatorMax[key] = generatorConfig[key].max;
    }
    saveCopy.generatorUpgrades = {};
    for (const key in generatorUpgrades) {
      saveCopy.generatorUpgrades[key] = {
        level: generatorUpgrades[key].level,
        cost: generatorUpgrades[key].cost.toString()
      };
    }
    saveCopy.generatorMaxUpgrades = {};
    for (const key in generatorMaxUpgrades) {
      saveCopy.generatorMaxUpgrades[key] = {
        cost: generatorMaxUpgrades[key].cost.toString()
      };
    }
    localStorage.setItem(username, JSON.stringify(saveCopy));
    localStorage.setItem('lastUsername', username);
    showToast('Game saved!');
  }

  function loadGame() {
    username = document.getElementById('username').value.trim();
    if (!username) { showToast('Enter a username first.'); return; }
    try {
      const savedData = localStorage.getItem(username);
      if (savedData) {
        const saved = JSON.parse(savedData);
        gameData = saved;
        // MIGRATION: Add missing fields for new generators/upgrades
        for (const key in generatorConfig) {
          if (typeof gameData[key] === "undefined" || isNaN(Number(gameData[key]))) {
            gameData[key] = "0";
          }
          if (!gameData.generatorMax) gameData.generatorMax = {};
          if (typeof gameData.generatorMax[key] === "undefined" || isNaN(Number(gameData.generatorMax[key]))) {
            gameData.generatorMax[key] = generatorConfig[key].max;
          }
          if (!gameData.generatorUpgrades) gameData.generatorUpgrades = {};
          if (!gameData.generatorUpgrades[key]) {
            gameData.generatorUpgrades[key] = {
              level: 0,
              cost: initialUpgradeCosts[key] ? initialUpgradeCosts[key].toString() : "1000"
            };
          }
          if (!gameData.generatorMaxUpgrades) gameData.generatorMaxUpgrades = {};
          if (!gameData.generatorMaxUpgrades[key]) {
            gameData.generatorMaxUpgrades[key] = {
              cost: initialMaxUpgradeCosts[key] ? initialMaxUpgradeCosts[key].toString() : "1000"
            };
          }
        }
        if (gameData.generatorMax) {
          for (const key in gameData.generatorMax) {
            generatorConfig[key].max = gameData.generatorMax[key];
          }
        }
        if (gameData.generatorUpgrades) {
          for (const key in gameData.generatorUpgrades) {
            generatorUpgrades[key].level = gameData.generatorUpgrades[key].level;
            generatorUpgrades[key].cost = new BigNumber(gameData.generatorUpgrades[key].cost);
          }
        }
        if (gameData.generatorMaxUpgrades) {
          for (const key in gameData.generatorMaxUpgrades) {
            if (gameData.generatorMaxUpgrades[key].cost)
              generatorMaxUpgrades[key].cost = new BigNumber(gameData.generatorMaxUpgrades[key].cost);
          }
        }
        recalculateEPS();
        updateAllUI();
        showToast('Game loaded!');
      } else {
        showToast('No save found for this username.');
      }
    } catch (e) {
      showToast('Corrupt save data. Resetting game.');
      resetGame();
    }
  }

  function resetGame() {
    if (confirm("Are you sure you want to reset your game? This cannot be undone!")) {
      gameData = JSON.parse(JSON.stringify(defaultGameData));
      for (const key in generatorConfig) {
        generatorConfig[key].max = defaultGameData.generatorMax[key];
      }
      for (const key in generatorUpgrades) {
        generatorUpgrades[key].level = 0;
        generatorUpgrades[key].cost = new BigNumber(initialUpgradeCosts[key]);
      }
      for (const key in generatorMaxUpgrades) {
        generatorMaxUpgrades[key].cost = new BigNumber(initialMaxUpgradeCosts[key]);
      }
      if (username) {
        localStorage.removeItem(username);
      }
      recalculateEPS();
      updateAllUI();
      showToast("Game reset to original state!");
    }
  }

  // --- Dynamic Generator Rendering ---
  let currentTier = 1;
  function renderGenerators() {
    const section = document.getElementById('generators-section');
    section.innerHTML = '';
    for (const key in generatorConfig) {
      if (generatorConfig[key].tier !== currentTier) continue;
      const gen = generatorConfig[key];
      const row = document.createElement('div');
      row.className = 'generator-row';
      row.innerHTML = `
        <span id="${gen.span}" class="generator-label">${gen.label}: 0 / ${gen.max}</span>
        <button id="${gen.button}" class="generator-btn"></button>
        <button id="${gen.sell}" class="sell-btn">Sell</button>
        <button id="${gen.upgrade}" class="upgrade-btn"></button>
        <button id="${gen.maxBtn}" class="max-btn"></button>
        <div id="factory-anim-${key}" class="factory-anim-container"></div>
      `;
      section.appendChild(row);
    }
    for (const key in generatorConfig) {
      if (generatorConfig[key].tier !== currentTier) continue;
      document.getElementById(generatorConfig[key].button).onclick = () => purchaseGenerator(key);
      document.getElementById(generatorConfig[key].sell).onclick = () => sellGenerator(key);
      document.getElementById(generatorConfig[key].upgrade).onclick = () => upgradeGenerator(key);
      document.getElementById(generatorConfig[key].maxBtn).onclick = () => upgradeMaxGenerator(key);
    }
    updateAllUI();
  }

  // --- Tier Button Logic ---
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.tier-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentTier = parseInt(this.getAttribute('data-tier'), 10);
        renderGenerators();
      });
    });
  });

  // --- Start Game After DOM Loads ---
  window.onload = function() {
    document.getElementById('purchase-multiplier').onchange = function() {
      multiplier = parseInt(this.value, 10);
      updateAllUI();
    };
    document.getElementById('saveBtn').onclick = saveGame;
    document.getElementById('loadBtn').onclick = loadGame;
    document.getElementById('resetBtn').onclick = resetGame;
    const lastUser = localStorage.getItem('lastUsername');
    if (lastUser) {
      document.getElementById('username').value = lastUser;
      username = lastUser;
      loadGame();
    } else {
      recalculateEPS();
      renderGenerators();
    }
    document.getElementById('storeBtn').onclick = function() {
      document.getElementById('store-modal').style.display = 'flex';
      updateAllUI();
    };
    document.getElementById('closeStoreBtn').onclick = function() {
      document.getElementById('store-modal').style.display = 'none';
    };
    document.getElementById('codeBtn').onclick = function() {
      document.getElementById('code-modal').style.display = 'flex';
      document.getElementById('codeInput').value = '';
      document.getElementById('codeResultMsg').style.display = 'none';
    };
    document.getElementById('closeCodeBtn').onclick = function() {
      document.getElementById('code-modal').style.display = 'none';
    };
    document.getElementById('redeemCodeBtn').onclick = function() {
      const code = document.getElementById('codeInput').value.trim().toUpperCase();
      const msg = document.getElementById('codeResultMsg');
      msg.style.display = '';
      if (code === 'FREE100K') {
        setEnergy(getEnergy().plus(100000));
        msg.textContent = 'Success! 100,000 energy added.';
        msg.style.color = '#69f0ae';
        showToast('Code redeemed: 100,000 energy!');
        updateAllUI();
      } else if (code === 'COALBOOST') {
        if (!perm2xCoal) {
          perm2xCoal = true;
          msg.textContent = 'Success! Permanent 2x Coal boost unlocked!';
          msg.style.color = '#69f0ae';
          showToast('Code redeemed: Permanent 2x Coal boost!');
          recalculateEPS();
          updateAllUI();
        } else {
          msg.textContent = 'Code already used.';
          msg.style.color = '#ff5252';
        }
      } else if (code === 'IRONBOOST2025') {
        if (!perm2xIron) {
          perm2xIron = true;
          msg.textContent = 'Success! Permanent 2x Iron boost unlocked!';
          msg.style.color = '#69f0ae';
          showToast('Code redeemed: Permanent 2x Iron boost!');
          recalculateEPS();
          updateAllUI();
        } else {
          msg.textContent = 'Code already used.';
          msg.style.color = '#ff5252';
        }
      } else {
        msg.textContent = 'Invalid code.';
        msg.style.color = '#ff5252';
      }
    };
    document.getElementById('buy-boost-2x').onclick = function() {
      if (boost2xActive) {
        showToast('Boost already active!');
        return;
      }
      const cost = new BigNumber(100000);
      if (!getEnergy().gte(cost)) {
        showToast('Not enough energy!');
        return;
      }
      setEnergy(getEnergy().minus(cost));
      boost2xActive = true;
      boost2xEndTime = Date.now() + 24 * 60 * 60 * 1000;
      showToast('2x Energy Output for 24h activated!');
      recalculateEPS();
      updateAllUI();
    };
    document.getElementById('buy-perm-2x-coal').onclick = function() {
      if (perm2xCoal) {
        showToast('Already purchased!');
        return;
      }
      const cost = new BigNumber(1000000);
      if (!getEnergy().gte(cost)) {
        showToast('Not enough energy!');
        return;
      }
      setEnergy(getEnergy().minus(cost));
      perm2xCoal = true;
      showToast('Permanent 2x Coal Generator Output purchased!');
      recalculateEPS();
      updateAllUI();
    };
    setInterval(() => {
      let totalAdd = new BigNumber(0);
      for (const key in generatorConfig) {
        let power = generatorConfig[key].power();
        if (key === 'coal' && perm2xCoal) power *= 2;
        if (key === 'iron' && perm2xIron) power *= 2;
        totalAdd = totalAdd.plus(getGenCount(generatorConfig[key].key).times(power));
      }
      if (boost2xActive) totalAdd = totalAdd.times(2);
      setEnergy(getEnergy().plus(totalAdd));
      recalculateEPS();
      updateAllUI();
    }, 1000);
    setInterval(() => {
      if (boost2xActive && Date.now() > boost2xEndTime) {
        boost2xActive = false;
        boost2xEndTime = 0;
        showToast('2x Energy Output boost expired.');
        recalculateEPS();
        updateAllUI();
      } else if (boost2xActive) {
        updateAllUI();
      }
    }, 10000);
    renderGenerators();
  };

  function formatBoostTime() {
    if (!boost2xActive) return '';
    const ms = boost2xEndTime - Date.now();
    if (ms <= 0) return 'Expired';
    const h = Math.floor(ms / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    return `${h}h ${m}m`;
  }
</script>
</body>
</html>